---
## If true, the FSM transitions are managed by an external tool
Managed: false
# If true and the FSM is self-managed, transitions should be triggered
StepByStep: false
# Change idle behaviour, if true the state is kept until transition,
# otherwise the FSM holds the last state until transition
IdleKeepState: true
# Where to look for state libraries
StatesLibraries:
- "@MC_CONTROLLER_INSTALL_PREFIX@/fsm/states"
# Where to look for state files
StatesFiles:
- "@MC_CONTROLLER_INSTALL_PREFIX@/fsm/states/data"
# If true, state factory will be more verbose
VerboseStateFactory: false

# Additional robots to load
robots:
  ground:
    module: env
    params:
    - "@AROBASE@MC_ENV_DESCRIPTION@AROBASE@"
    - ground
# General constraints, always on
constraints:
-  type: contact
-  type: kinematics
   robotIndex: 0
   damper: [0.1, 0.01, 0.5]
# Collision constraint
collisions:
- type: collision
  r1Index: 0
  r2Index: 0
  useMinimal: true
# Initial set of contacts
contacts: {}
hrp2_drc:
  posture:
    stiffness: 1.0
    weight: 10.0
jvrc1:
  posture:
    stiffness: 1.0
    weight: 10.0
# Implement some additional text states
states:
  MinimalStabilizerState:
    base: StabilizerStanding
    StabilizerConfig:
      type: lipm_stabilizer
      robotIndex: 0
      # start in enabled/disabled state
      enabled: true

  CustomConfigurationStabilizerState:
    base: MinimalStabilizerState

    # Add contacts to the solver.
    # Note that in order for the stabilizer to work, roll and pitch DoF need to be free to allow for admittance
    # control of the feet, and vertical DoF to allow for foot force-difference control.
    AddContacts:
    - r1: hrp2_drc
      r2: ground
      r1Surface: LeftFootCenter
      r2Surface: AllGround
      dof: [0, 0, 1, 1, 1, 0]
    - r1: hrp2_drc
      r2: ground
      r1Surface: RightFootCenter
      r2Surface: AllGround
      dof: [0, 0, 1, 1, 1, 0]

    StabilizerConfig:
      robotIndex: 0
      enabled: true

      ###########################
      ## Stabilizer configuration
      ###########################
      # Default values for these robot-specific parameters are set in the corresponding robot module.
      # You may choose to override any of them here, with due caution.
      hrp2_drc:
        leftFootSurface: LeftFootCenter
        rightFootSurface: RightFootCenter
        friction: 0.8
        torsoBodyName: CHEST_LINK1
        # Configuration  of the QP tasks used by the stabilizer
        tasks:
          com:
            stiffness: [1000, 1000, 100]
            weight: 1000
            active_joints: [Root, RLEG_JOINT0, RLEG_JOINT1, RLEG_JOINT2, RLEG_JOINT3, RLEG_JOINT4, RLEG_JOINT5, LLEG_JOINT0, LLEG_JOINT1, LLEG_JOINT2, LLEG_JOINT3, LLEG_JOINT4, LLEG_JOINT5]
            height: 0.87
            max_height: 0.92
            min_height: 0.6
          contact:
            damping: 300
            stiffness: 1
            weight: 10000

        # Weights for the force-distribution QP
        fdqp_weights:
          net_wrench: 10000
          ankle_torque: 100
          pressure: 1

        # Vertical drift frequency
        vdc:
          frequency: 1
          stiffness: 1000

        # Admittance coefficients (force-control)
        admittance:
          com: [0, 0]
          cop: [0.001, 0.001]

        ########################
        # Gains for DCM tracking
        ########################
        # These are the main gains of the stabilizer.
        dcm_tracking:
          gains:
            prop: 3
            integral: 20
            deriv: 0.5
          derivator_time_constant: 5
          integrator_time_constant: 30

      # Change some parameters for another robot
      jvrc1:
        dcm_tracking:
          gains:
            prop: 4
            integral: 10
            deriv: 0.5

  ####
  # States to handle the various support configuration of the stabilizer:
  # - DoubleSupport to move from left to right foot freely
  # - Left foot support to lift the right foot
  # - Right foot support to lift the left foot
  # Note that when swithing from double support to single support, it is the user'r responsibility to
  # ensure that a suitable tasks is added to the solver to control the free foot.
  ####
  StabilizerGoStanding:
    base: MinimalStabilizerState
    # left foot ratio
    # 0: on left foot
    # 1: on right foot
    target: 0.5
    contactState: DoubleSupport
    completion:
      dcmEval: [0.005, 0.005, 0.05]

  StabilizerGoLeft:
    base: StabilizerGoStanding
    target: 0

  StabilizerGoRight:
    base: StabilizerGoStanding
    target: 1

  StabilizerStayLeft:
    base: StabilizerGoLeft

  StabilizerStayRight:
    base: StabilizerGoRight

  StabilizerLeftSupport:
    base: StabilizerGoLeft
    contactState: Left
    completion: {}

  StabilizerRightSupport:
    base: StabilizerGoRight
    contactState: Right
    completion: {}

  ####
  # Tasks to handle the free foot
  # - Lift up phase: surface transform moving above the current position
  # - Put down phase: admittance tasks looking for a positive force above a threshold
  ####
  LiftRightSwingFoot:
    base: MetaTasks
    tasks:
      LiftFootTask:
        type: surfaceTransform
        stiffness: 10
        weight: 500
        robotIndex: 0
        surface: "RightFootCenter"
        moveWorld:
          translation: [0,0,0.1]
        completion:
          eval: 0.01

  LiftLeftSwingFoot:
    base: LiftRightSwingFoot
    tasks:
      LiftFootTask:
        surface: "LeftFootCenter"

  PutRightSwingFootDown:
    base: MetaTasks
    tasks:
      PutFootAdmittance:
        type: admittance
        robotIndex: 0
        surface: "RightFootCenter"
        stiffness: [10, 10, 10, 10, 10, 10]
        damping: [6.3, 6.3, 6.3, 6.3, 6.3, 300]
        admittance: [0,0,0,0,0,0.005]
        wrench:
         force: [0, 0, 20]
         couple: [0, 0, 0]
        moveWorld:
          translation: [0, 0, -0.1]
        targetRotation: [0, 0, 0]
        completion:
          wrench:
            force: [.nan, .nan, 20]
            couple: [.nan, .nan, .nan]

  PutLeftSwingFootDown:
    base: PutRightSwingFootDown
    tasks:
      PutFootAdmittance:
        surface: "LeftFootCenter"

  ####
  # The suitable stabilization mode are put in parallel to free foot motion tasks
  # to achieve stabilized motions
  ####

  # Lift and put down the right foot
  StabilizerLiftRightFoot:
    base: Parallel
    states: [StabilizerLeftSupport, LiftRightSwingFoot]

  StabilizerPutRightFoot:
    base: Parallel
    states: [StabilizerLeftSupport, PutRightSwingFootDown]

  # Lift and put down the left foot
  StabilizerLiftLeftFoot:
    base: Parallel
    states: [LiftLeftSwingFoot, StabilizerRightSupport]
  StabilizerPutLeftFoot:
    base: Parallel
    states: [PutLeftSwingFootDown, StabilizerRightSupport]

  FSMLiftRightFootAuto:
    base: "Meta"
    StepByStep: false,
    transitions:
    - [StabilizerStanding, OK, StabilizerGoLeft, Auto]
    - [StabilizerGoLeft, OK, StabilizerLiftRightFoot, Auto]
    - [StabilizerLiftRightFoot, OK, StabilizerPutRightFoot, Auto]

  FSMLiftRightFootManual:
    base: "Meta"
    transitions:
    - [StabilizerStanding, OK, StabilizerGoLeft, Strict]
    - [StabilizerGoLeft, OK, StabilizerLiftRightFoot, Strict]
    - [StabilizerLiftRightFoot, OK, StabilizerPutRightFoot, Strict]
      # This transition occurs automatically as you want to be reverting back to foot force difference control as soon as the foot touches the floor. Here the admittance task is only used to look for contact, not to control the post contact phase.
    - [StabilizerPutRightFoot, OK, StabilizerStayLeft, Auto]

  FSMLiftLeftFootAuto:
    base: "Meta"
    transitions:
    - [StabilizerStanding, OK, StabilizerGoRight, Auto]
    - [StabilizerGoRight, OK, StabilizerLiftLeftFoot, Auto]
    - [StabilizerLiftLeftFoot, OK, StabilizerPutLeftFoot, Auto]

  FSMLiftLeftFootManual:
    base: "Meta"
    transitions:
    - [StabilizerStanding, OK, StabilizerGoRight, Strict]
    - [StabilizerGoRight, OK, StabilizerLiftLeftFoot, Strict]
    - [StabilizerLiftLeftFoot, OK, StabilizerPutLeftFoot, Strict]
    - [StabilizerPutLeftFoot, OK, StabilizerStayRight, Auto]

  FSMAlternateFeetLiftingAuto:
    base: "Meta"
    transitions:
    - [FSMLiftLeftFootAuto, OK, FSMLiftRightFootAuto]

###
# Transitions map
# We rely here on the forced transitions to let the user choose what state to execute next
# from a predefined list of suitable states all reachable safely from the StabilizerStanding state
#
# Note: Handle with caution, but by forcing the transitions early, notably while putting the foot down, this FSM may be used to test disturbances to the stabilizer (eg early contact, early lift-off, etc). Be cautious that if triggered too early, this may result in high impact on the feet.
###
transitions:
- [MinimalStabilizerState, Custom, CustomConfigurationStabilizerState, Strict]
- [MinimalStabilizerState, Standing, StabilizerStanding, Strict]
- [CustomConfigurationStabilizerState, Custom, MinimalStabilizerState, Strict]
  # FSM to move CoM to right foot and lift the left one
- [StabilizerStanding, Lift left foot (Auto), FSMLiftLeftFootAuto, Strict]
- [FSMLiftLeftFootAuto, OK, StabilizerStanding, Auto]
- [StabilizerStanding, Lift left foot (Manual), FSMLiftLeftFootManual, Strict]
- [FSMLiftLeftFootManual, OK, StabilizerStanding, Strict]
  # FSM to move CoM to right foot and lift the left one
- [StabilizerStanding, Lift right foot (Auto), FSMLiftRightFootAuto, Strict]
- [FSMLiftRightFootAuto, OK, StabilizerStanding, Auto]
- [StabilizerStanding, Lift right foot (Manual), FSMLiftRightFootManual, Strict]
- [FSMLiftRightFootManual, OK, StabilizerStanding, Strict]
  # Alternate between lifting left and right foot
- [StabilizerStanding, Alternate between feet (Auto), FSMAlternateFeetLiftingAuto, Auto]
- [FSMAlternateFeetLiftingAuto, OK, StabilizerStanding, Auto]

# Initial state
init: MinimalStabilizerState


# Specific configuration for each observer
Observers:
  Encoder:
    # Valid values are [estimator, control, none]
    UpdatePositionFrom: estimator
    UpdateVelocityFrom: estimator
  BodySensor:
    # Valid entries are [control, estimator, none]
    UpdateFrom: estimator
    FloatingBaseSensor: FloatingBase
RunObservers: [Encoder, KinematicInertial, CoMVelocity]
UpdateObservers: [Encoder, KinematicInertial]
